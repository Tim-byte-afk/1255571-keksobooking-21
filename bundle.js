(()=>{"use strict";window.util={getRandomArray:(e,t)=>{for(let t=e.length-1;t>0;t--){const o=Math.floor(Math.random()*(t+1));[e[o],e[t]]=[e[t],e[o]]}return e.slice(0,t+1)},getRandomNumber:(e,t)=>(e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e))+e),declOfNum:(e,t)=>t[e%100>4&&e%100<20?2:[2,0,1,1,1,2][e%10<5?e%10:5]]},window.debounce=e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),500)}},(()=>{const e=document.querySelector("#error").content,t=document.querySelector("main"),o=document.querySelector(".notice"),n=document.querySelector("#success").content;window.popUps={error:n=>{const r=document.createDocumentFragment(),i=e.cloneNode(!0),d=i.querySelector(".error"),a=i.querySelector(".error__button"),s=i.querySelector(".error__message");n&&(s.textContent=n),r.appendChild(i),t.insertBefore(r,o),a.addEventListener("click",(()=>{d.remove()})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&(e.preventDefault(),d.remove())}))},success:()=>{const e=document.createDocumentFragment(),r=n.cloneNode(!0),i=r.querySelector(".success");e.appendChild(r),t.insertBefore(e,o),document.addEventListener("click",(()=>{i.remove()})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&(e.preventDefault(),i.remove())}))}}})(),window.loadData=(e,t,o,n,r)=>{const i=new XMLHttpRequest;i.responseType="json",i.addEventListener("load",(()=>{let e;switch(i.status){case 200:o(i.response);break;case 400:e="Неверный запрос";break;case 401:e="Пользователь не авторизован";break;case 404:e="Ничего не найдено";break;default:e="Cтатус ответа: : "+i.status+" "+i.statusText}e&&n(e)})),i.addEventListener("error",(()=>{n("Произошла ошибка соединения")})),i.addEventListener("timeout",(()=>{n("Запрос не успел выполниться за "+i.timeout+"мс")})),i.timeout=5e3,i.open(t,e),r?i.send(r):i.send()},window.data={OFFER_TYPES:{bungalow:{label:"Бунгало",minPrice:0},flat:{label:"Квартира",minPrice:1e3},house:{label:"Дом",minPrice:5e3},palace:{label:"Дворец",minPrice:1e4}},MIN_Y_LOCATION:130,MAX_Y_LOCATION:630,response:void 0},(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin"),t=document.querySelector(".map__pins");window.pin={elementWidth:65,elementHeight:87,create:o=>{const n=document.createDocumentFragment(),r=o.length<=5?o.length:5;for(let t=0;t<r;t++){const r=o[t],i=r.location.x-32.5,d=r.location.y-87,a=e.cloneNode(!0);a.style="left: "+i+"px; top: "+d+"px;",a.dataset.id=r.id,n.appendChild(a);const s=a.querySelector("img");s.src=r.author.avatar,s.alt=r.offer.title,a.appendChild(s)}t.appendChild(n)}}})(),(()=>{const e=document.querySelector("#card").content.querySelector(".popup"),t=document.querySelector(".map__filters-container");window.createCard=(o,n)=>{const r=o.offer.rooms+" "+window.util.declOfNum(o.offer.rooms,["комната","комнаты","комнат"])+" для "+o.offer.guests+" "+window.util.declOfNum(o.offer.guests,["гостя","гостей","гостей"])+".",i=window.data.OFFER_TYPES[o.offer.type].label,d=document.createDocumentFragment(),a=e.cloneNode(!0),s=a.querySelector("img");o.author.avatar?s.src=o.author.avatar:s.remove();const c=a.querySelector(".popup__title");o.offer.title?c.textContent=o.offer.title:c.remove();const l=a.querySelector(".popup__text--address");o.offer.address?l.textContent=o.offer.address:l.remove();const u=a.querySelector(".popup__text--price");o.offer.price?u.textContent=o.offer.price+"₽/ночь":u.remove();const m=a.querySelector(".popup__type");o.offer.type?m.textContent=i:m.remove();const p=a.querySelector(".popup__text--capacity");o.offer.rooms&&o.offer.guests?p.textContent=r:p.remove();const f=a.querySelector(".popup__text--time");o.offer.checkin&&o.offer.checkout?f.textContent="Заезд после "+o.offer.checkin+", выезд до "+o.offer.checkout:f.remove();const w=a.querySelector(".popup__description");o.offer.description?w.textContent=o.offer.description:w.remove();const v=a.querySelector(".popup__features");if(v.innerHTML="",o.offer.features.length>0)for(const e of o.offer.features){const t=document.createElement("li");t.classList.add("popup__feature","popup__feature--"+e),v.appendChild(t)}else v.remove();const y=a.querySelector(".popup__photos"),h=y.querySelector(".popup__photo");if(o.offer.photos.length>0){for(const e of o.offer.photos){const t=h.cloneNode(!0);t.src=e,y.appendChild(t)}h.remove(),a.appendChild(y)}else y.remove();d.appendChild(a),n.insertBefore(d,t)}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector("#room_number"),o=document.querySelector("#capacity"),n=document.querySelector("#title"),r=document.querySelector("#price"),i=document.querySelector("#type"),d=document.querySelector("#timein"),a=document.querySelector("#timeout"),s=document.querySelector(".ad-form__field input[type=file]"),c=document.querySelector(".ad-form-header__preview img"),l=document.querySelector(".ad-form__upload input[type=file]"),u=document.querySelector(".ad-form__photo"),m=()=>{const e=u.querySelector("img");e&&e.remove()},p=(t,o,n)=>{const r=t.files[0],i=r.name.toLowerCase();if(e.some((e=>i.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{if(n)o.src=e.result;else{m();const t=document.createElement("img");t.src=e.result,t.width=70,t.height=70,t.alt="Фотография жилья",o.appendChild(t)}})),e.readAsDataURL(r)}};s.addEventListener("change",(()=>p(s,c,!0))),l.addEventListener("change",(()=>p(l,u)));const f=()=>{w.reset(),c.src="img/muffin-grey.svg",m()};n.setAttribute("minlength",30),n.setAttribute("maxlength",100),r.setAttribute("max",1e6);const w=document.querySelector(".ad-form"),v=w.querySelectorAll("fieldset"),y=document.querySelector(".ad-form__reset"),h=e=>{for(let t of e)t.removeAttribute("disabled")},_=document.querySelector(".map__filters").querySelectorAll("select, fieldset"),g=e=>{for(let t of e)t.setAttribute("disabled","true")},S=(e,t)=>{const o=Number(e.offsetLeft),n=Number(e.offsetTop),r=Number(e.offsetWidth),i=Number(e.offsetHeight),d=t?i+22:i/2;return Math.round(o+r/2)+", "+Math.round(n+d)},q=(e,t)=>{const o=Number(e.value),n=Number(t.value);o>n&&0!==o&&100!==n?t.setCustomValidity("Количество комнат меньше кол-ва гостей на "+(o-n)):0===o&&100!==n||100===n&&0!==o?t.setCustomValidity("Неверное значение."):t.setCustomValidity("")},L=()=>{const e=String(i.value),t=window.data.OFFER_TYPES[e].minPrice;r.placeholder=t,r.min=t},E=(e,t)=>{t.value=e.value};o.addEventListener("change",(()=>{q(o,t),t.reportValidity()})),t.addEventListener("change",(()=>{q(o,t),t.reportValidity()})),i.addEventListener("change",(()=>{L()})),d.addEventListener("change",(()=>{E(d,a)})),a.addEventListener("change",(()=>{E(a,d)})),n.addEventListener("input",(()=>{b()})),r.addEventListener("input",(()=>{b()}));const b=()=>{""===n.value?n.setCustomValidity("Поле не может быть пустым!"):n.setCustomValidity(""),""===r.value?r.setCustomValidity("Поле не может быть пустым!"):r.setCustomValidity("")};y.addEventListener("click",(()=>{f(),window.map.filterForm.reset(),window.map.inputAddress.value=S(window.map.mainElementPin)})),window.form={element:w,validateGuestsAndRooms:q,setPlaceholderForPrice:L,getCoordinate:S,activate:()=>{window.map.element.classList.remove("map--faded"),w.classList.remove("ad-form--disabled"),h(v),h(_),window.map.inputAddress.value=S(window.map.mainElementPin,!0),window.form.validateGuestsAndRooms(window.form.housingGuests,window.form.housingRooms),window.form.setPlaceholderForPrice(),window.map.eventListenersList(),b()},deactivate:()=>{g(v),g(_)},housingRooms:t,housingGuests:o,fieldsetList:v,checkEmptyFields:b,clean:f}})(),(()=>{const e={middle:{min:1e4,max:5e4},low:{min:0,max:1e4},high:{min:5e4,max:999999999}},t="any",o=document.querySelector(".map"),n=o.offsetWidth,r=document.querySelector(".map__pins"),i=document.querySelector(".map__filters"),d=document.querySelector("#housing-type"),a=document.querySelector("#housing-price"),s=document.querySelector("#housing-rooms"),c=document.querySelector("#housing-guests"),l=document.querySelector("#housing-features"),u=e=>{"Escape"===e.key&&(e.preventDefault(),m())},m=()=>{p(),document.removeEventListener("keydown",u)},p=()=>{const e=window.map.element.querySelector(".map__card");e&&e.remove()},f=document.querySelector(".map__pin--main"),w=document.querySelector("#address"),v=e=>{const t=Number(e.offsetWidth);return Math.round(e.offsetLeft+t/2)+", "+Math.round(e.offsetTop)},y=()=>{const e=document.querySelectorAll(".map__pin:not(.map__pin--main)");for(let t of e)t.remove()},h=(o,n)=>{let r=0;return(d.value===t||String(o.offer.type)===String(d.value))&&r++,(c.value===t||String(o.offer.guests)===String(c.value))&&r++,(s.value===t||String(o.offer.rooms)===String(s.value))&&r++,(a.value===t||Number(e[a.value].min)<Number(o.offer.price)&&Number(e[a.value].max)>Number(o.offer.price))&&r++,(0===Number(n.length)||new Set(n.concat(o.offer.features)).size===Number(o.offer.features.length))&&r++,5===r},_=()=>{let e=[];const t=window.data.response;p(),y();const o=Array.from(l.querySelectorAll('input[type="checkbox"]:checked')).map((e=>e.value));for(let n=0;n<t.length;n++){const r=t[n];if(h(r,o)&&(e.push(r),5===e.length))break}e.length>0&&window.pin.create(e)};d.addEventListener("change",window.debounce(_)),a.addEventListener("change",window.debounce(_)),s.addEventListener("change",window.debounce(_)),c.addEventListener("change",window.debounce(_)),l.addEventListener("change",window.debounce(_)),window.map={element:o,filterForm:i,mainElementPin:f,elementWidth:n,elementContainer:r,eventListenersList:()=>{r.addEventListener("click",(e=>{(e=>{const t=e.target.closest(".map__pin:not(.map__pin--main)");if(t){const e=t.dataset.id,n=window.data.response.find((t=>String(t.id)===String(e)));p(),window.createCard(n,o),window.map.element.querySelector(".popup__close").addEventListener("click",(()=>{m()})),document.addEventListener("keydown",u)}})(e)}))},inputAddress:w,setStartedCoordinate:()=>{f.style.top="375px",f.style.left="570px",w.value=window.form.getCoordinate(f)},removeAllPopups:p,movePin:e=>{e.preventDefault();let t={x:e.clientX,y:e.clientY};const o=e=>{e.preventDefault();let o=t.x-e.clientX,n=t.y-e.clientY;t={x:e.clientX,y:e.clientY};let i=f.offsetTop-n,d=f.offsetLeft-o;i<window.data.MIN_Y_LOCATION?i=window.data.MIN_Y_LOCATION:i>window.data.MAX_Y_LOCATION&&(i=window.data.MAX_Y_LOCATION),d<0-window.pin.elementWidth/2?d=0-window.pin.elementWidth/2:d>r.offsetWidth-window.pin.elementWidth/2&&(d=r.offsetWidth-window.pin.elementWidth/2),f.style.top=i+"px",f.style.left=d+"px",w.value=v(f)},n=e=>{e.preventDefault(),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",n),w.value=v(f)};document.addEventListener("mousemove",o),document.addEventListener("mouseup",n)},removeAllPins:y}})(),(()=>{const e=()=>{window.form.deactivate()};e();let t=!1;const o=e=>{window.form.activate(!0),e.forEach(((e,t)=>{e.id=t+1})),window.data.response=e,window.pin.create(window.data.response)},n=e=>{t=!1,window.popUps.error(e)},r=e=>{t?window.map.movePin(e):(window.loadData("https://21.javascript.pages.academy/keksobooking/data","GET",o,n),window.map.setStartedCoordinate(),t=!0)};window.map.mainElementPin.addEventListener("mousedown",(e=>{if("object"==typeof e)switch(e.button){case 0:r(e)}})),window.map.mainElementPin.addEventListener("keydown",(e=>{"Enter"===e.key&&r()}));const i=()=>{e(),window.map.removeAllPopups(),window.map.element.classList.add("map--faded"),window.form.element.classList.add("ad-form--disabled"),window.map.removeAllPins(),window.form.clean(),window.map.filterForm.reset(),window.map.setStartedCoordinate(),window.popUps.success(),t=!1},d=()=>{window.popUps.error()};window.form.element.addEventListener("submit",(e=>{window.loadData("https://21.javascript.pages.academy/keksobooking","POST",i,d,new FormData(window.form.element)),e.preventDefault()}))})()})();