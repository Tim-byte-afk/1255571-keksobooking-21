(()=>{"use strict";window.util={getRandomArray:function(e,t){for(let t=e.length-1;t>0;t--){const o=Math.floor(Math.random()*(t+1));[e[o],e[t]]=[e[t],e[o]]}return e.slice(0,t+1)},getRandomNumber:function(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e))+e},declOfNum:function(e,t){return t[e%100>4&&e%100<20?2:[2,0,1,1,1,2][e%10<5?e%10:5]]}},window.debounce=e=>{let t=null;return function(...o){t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),500)}},(()=>{const e=document.querySelector("#error").content,t=document.querySelector("main"),o=document.querySelector(".notice"),n=document.querySelector("#success").content;window.popUps={showPopupError:function(n){const r=document.createDocumentFragment(),i=e.cloneNode(!0),d=i.querySelector(".error"),a=i.querySelector(".error__button"),c=i.querySelector(".error__message");n&&(c.textContent=n),r.appendChild(i),t.insertBefore(r,o),a.addEventListener("click",(()=>{d.remove()})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&(e.preventDefault(),d.remove())}))},showPopupSuccess:function(){const e=document.createDocumentFragment(),r=n.cloneNode(!0),i=r.querySelector(".success");e.appendChild(r),t.insertBefore(e,o),document.addEventListener("click",(()=>{i.remove()})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&(e.preventDefault(),i.remove())}))}}})(),window.loadData=(e,t,o,n,r)=>{const i=new XMLHttpRequest;i.responseType="json",i.addEventListener("load",(function(){let e;switch(i.status){case 200:o(i.response);break;case 400:e="Неверный запрос";break;case 401:e="Пользователь не авторизован";break;case 404:e="Ничего не найдено";break;default:e="Cтатус ответа: : "+i.status+" "+i.statusText}e&&n(e)})),i.addEventListener("error",(function(){n("Произошла ошибка соединения")})),i.addEventListener("timeout",(function(){n("Запрос не успел выполниться за "+i.timeout+"мс")})),i.timeout=5e3,i.open(t,e),r?i.send(r):i.send()},window.data={OFFER_TYPES:{bungalow:{label:"Бунгало",minPrice:0},flat:{label:"Квартира",minPrice:1e3},house:{label:"Дом",minPrice:5e3},palace:{label:"Дворец",minPrice:1e4}},MIN_Y_LOCATION:130,MAX_Y_LOCATION:630,response:void 0},(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin"),t=document.querySelector(".map__pins");window.pin={elementWidth:65,elementHeight:87,create:function(o){const n=document.createDocumentFragment(),r=o.length<=5?o.length:5;for(let t=0;t<r;t++){const r=o[t],i=r.location.x-32.5,d=r.location.y-87,a=e.cloneNode(!0);a.style="left: "+i+"px; top: "+d+"px;",a.dataset.id=r.id,n.appendChild(a);const c=a.querySelector("img");c.src=r.author.avatar,c.alt=r.offer.title,a.appendChild(c)}t.appendChild(n)}}})(),(()=>{const e=document.querySelector("#card").content.querySelector(".popup"),t=document.querySelector(".map__filters-container");window.createCard=function(o,n){const r=o.offer.rooms+" "+window.util.declOfNum(o.offer.rooms,["комната","комнаты","комнат"])+" для "+o.offer.guests+" "+window.util.declOfNum(o.offer.guests,["гостя","гостей","гостей"])+".",i=window.data.OFFER_TYPES[o.offer.type].label,d=document.createDocumentFragment(),a=e.cloneNode(!0),c=a.querySelector("img");o.author.avatar?c.src=o.author.avatar:c.remove();const s=a.querySelector(".popup__title");o.offer.title?s.textContent=o.offer.title:s.remove();const u=a.querySelector(".popup__text--address");o.offer.address?u.textContent=o.offer.address:u.remove();const l=a.querySelector(".popup__text--price");o.offer.price?l.textContent=o.offer.price+"₽/ночь":l.remove();const m=a.querySelector(".popup__type");o.offer.type?m.textContent=i:m.remove();const p=a.querySelector(".popup__text--capacity");o.offer.rooms&&o.offer.guests?p.textContent=r:p.remove();const f=a.querySelector(".popup__text--time");o.offer.checkin&&o.offer.checkout?f.textContent="Заезд после "+o.offer.checkin+", выезд до "+o.offer.checkout:f.remove();const w=a.querySelector(".popup__description");o.offer.description?w.textContent=o.offer.description:w.remove();const v=a.querySelector(".popup__features");if(v.innerHTML="",o.offer.features.length>0)for(const e of o.offer.features){const t=document.createElement("li");t.classList.add("popup__feature","popup__feature--"+e),v.appendChild(t)}else v.remove();const h=a.querySelector(".popup__photos"),y=h.querySelector(".popup__photo");if(o.offer.photos.length>0){for(const e of o.offer.photos){const t=y.cloneNode(!0);t.src=e,h.appendChild(t)}y.remove(),a.appendChild(h)}else h.remove();d.appendChild(a),n.insertBefore(d,t)}})(),(()=>{const e=document.querySelector("#room_number"),t=document.querySelector("#capacity"),o=document.querySelector("#title"),n=document.querySelector("#price"),r=document.querySelector("#type"),i=document.querySelector("#timein"),d=document.querySelector("#timeout");o.setAttribute("minlength",30),o.setAttribute("maxlength",100),n.setAttribute("max",1e6);const a=document.querySelector(".ad-form"),c=a.querySelectorAll("fieldset"),s=document.querySelector(".ad-form__reset"),u=function(e){for(let t of e)t.removeAttribute("disabled")},l=document.querySelector(".map__filters").querySelectorAll("select, fieldset"),m=function(e){for(let t of e)t.setAttribute("disabled","true")},p=function(e,t){const o=Number(e.offsetLeft),n=Number(e.offsetTop),r=Number(e.offsetWidth),i=Number(e.offsetHeight),d=t?i+22:i/2;return Math.round(o+r/2)+", "+Math.round(n+d)},f=function(e,t){const o=Number(e.value),n=Number(t.value);o>n&&0!==o&&100!==n?t.setCustomValidity("Количество комнат меньше кол-ва гостей на "+(o-n)):0===o&&100!==n||100===n&&0!==o?t.setCustomValidity("Неверное значение."):t.setCustomValidity("")},w=()=>{const e=String(r.value),t=window.data.OFFER_TYPES[e].minPrice;n.placeholder=t,n.min=t},v=(e,t)=>{t.value=e.value};t.addEventListener("change",(function(){f(t,e),e.reportValidity()})),e.addEventListener("change",(function(){f(t,e),e.reportValidity()})),r.addEventListener("change",(function(){w()})),i.addEventListener("change",(function(){v(i,d)})),d.addEventListener("change",(function(){v(d,i)})),o.addEventListener("input",(function(){h()})),n.addEventListener("input",(function(){h()}));const h=()=>{""===o.value?o.setCustomValidity("Поле не может быть пустым!"):o.setCustomValidity(""),""===n.value?n.setCustomValidity("Поле не может быть пустым!"):n.setCustomValidity("")};s.addEventListener("click",(()=>{a.reset(),window.map.inputAddress.value=p(window.map.mainElementPin)})),window.form={element:a,validateGuestsAndRooms:f,setPlaceholderForPrice:w,getCoordinate:p,activate:function(){window.map.element.classList.remove("map--faded"),a.classList.remove("ad-form--disabled"),u(c),u(l),window.map.inputAddress.value=p(window.map.mainElementPin,!0),window.form.validateGuestsAndRooms(window.form.housingGuests,window.form.housingRooms),window.form.setPlaceholderForPrice(),window.map.eventListenersList(),h()},deactivate:function(){m(c),m(l)},housingRooms:e,housingGuests:t,fieldsetList:c,checkEmptyFields:h}})(),(()=>{const e={middle:{min:1e4,max:5e4},low:{min:0,max:1e4},high:{min:5e4,max:999999999}},t="any",o=document.querySelector(".map"),n=o.offsetWidth,r=document.querySelector(".map__pins"),i=document.querySelector("#housing-type"),d=document.querySelector("#housing-price"),a=document.querySelector("#housing-rooms"),c=document.querySelector("#housing-guests"),s=document.querySelector("#housing-features"),u=e=>{"Escape"===e.key&&(e.preventDefault(),l())},l=()=>{m(),document.removeEventListener("keydown",u)},m=()=>{const e=window.map.element.querySelector(".map__card");e&&e.remove()},p=document.querySelector(".map__pin--main"),f=document.querySelector("#address"),w=e=>{const t=Number(e.offsetWidth);return Math.round(e.offsetLeft+t/2)+", "+Math.round(e.offsetTop)},v=()=>{const e=document.querySelectorAll(".map__pin:not(.map__pin--main)");for(let t of e)t.remove()},h=(o,n)=>{let r=0;return(i.value===t||String(o.offer.type)===String(i.value))&&r++,(c.value===t||String(o.offer.guests)===String(c.value))&&r++,(a.value===t||String(o.offer.rooms)===String(a.value))&&r++,(d.value===t||Number(e[d.value].min)<Number(o.offer.price)&&Number(e[d.value].max)>Number(o.offer.price))&&r++,(0===Number(n.length)||new Set(n.concat(o.offer.features)).size===Number(o.offer.features.length))&&r++,5===r},y=()=>{let e=[];const t=window.data.response;m(),v();const o=Array.from(s.querySelectorAll('input[type="checkbox"]:checked')).map((e=>e.value));for(let n=0;n<t.length;n++){const r=t[n];if(h(r,o)&&(e.push(r),5===e.length))break;console.log(e.length)}e.length>0&&window.pin.create(e)};i.addEventListener("change",window.debounce(y)),d.addEventListener("change",window.debounce(y)),a.addEventListener("change",window.debounce(y)),c.addEventListener("change",window.debounce(y)),s.addEventListener("change",window.debounce(y)),window.map={element:o,mainElementPin:p,elementWidth:n,elementContainer:r,eventListenersList:()=>{r.addEventListener("click",(function(e){(e=>{const t=e.target.closest(".map__pin:not(.map__pin--main)");if(t){const e=t.dataset.id,n=window.data.response.find((t=>String(t.id)===String(e)));m(),window.createCard(n,o),window.map.element.querySelector(".popup__close").addEventListener("click",(function(){l()})),document.addEventListener("keydown",u)}})(e)}))},inputAddress:f,setStartedCoordinate:()=>{p.style.top="375px",p.style.left="570px",f.value=window.form.getCoordinate(p)},removeAllPopups:m,movePin:e=>{e.preventDefault();let t={x:e.clientX,y:e.clientY};const o=function(e){e.preventDefault();let o=t.x-e.clientX,n=t.y-e.clientY;t={x:e.clientX,y:e.clientY};let i=p.offsetTop-n,d=p.offsetLeft-o;i<window.data.MIN_Y_LOCATION?i=window.data.MIN_Y_LOCATION:i>window.data.MAX_Y_LOCATION&&(i=window.data.MAX_Y_LOCATION),d<0-window.pin.elementWidth/2?d=0-window.pin.elementWidth/2:d>r.offsetWidth-window.pin.elementWidth/2&&(d=r.offsetWidth-window.pin.elementWidth/2),p.style.top=i+"px",p.style.left=d+"px",f.value=w(p)},n=function(e){e.preventDefault(),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",n),f.value=w(p)};document.addEventListener("mousemove",o),document.addEventListener("mouseup",n)},removeAllPins:v}})(),(()=>{const e=()=>{window.form.deactivate()};e();let t=!1;const o=e=>{window.form.activate(!0),e.forEach(((e,t)=>{e.id=t+1})),window.data.response=e,window.pin.create(window.data.response)},n=e=>{t=!1,window.popUps.showPopupError(e)},r=e=>{t?window.map.movePin(e):(window.loadData("https://21.javascript.pages.academy/keksobooking/data","GET",o,n),window.map.setStartedCoordinate(),t=!0)};window.map.mainElementPin.addEventListener("mousedown",(function(e){if("object"==typeof e)switch(e.button){case 0:r(e)}})),window.map.mainElementPin.addEventListener("keydown",(function(e){"Enter"===e.key&&r()}));const i=()=>{e(),window.map.removeAllPopups(),window.map.element.classList.add("map--faded"),window.form.element.classList.add("ad-form--disabled"),window.map.removeAllPins(),window.form.element.reset(),window.map.setStartedCoordinate(),window.popUps.showPopupSuccess(),t=!1},d=()=>{window.popUps.showPopupError()};window.form.element.addEventListener("submit",(e=>{window.loadData("https://21.javascript.pages.academy/keksobooking","POST",i,d,new FormData(window.form.element)),e.preventDefault()}))})()})();